const GEMINI_API_KEY = "AIzaSyCs9KgzezS2nl_n2oojGh-60i0QPRzNXoo"; // Ideally, move this to Script Properties for security

function doPost(e) {
  // Add lock to prevent race conditions
  const lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    const data = JSON.parse(e.postData.contents);

    // --- ROUTE 1: AI ANALYSIS ---
    if (data.action === "analyze") {
      const analysis = callGemini(data.stats, data.clientName);
      
      // We must return JSON
      return ContentService.createTextOutput(JSON.stringify({ result: "success", analysis: analysis }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // --- ROUTE 2: SAVE DATA ---
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // Batch the append for speed
    // (Ensure your sheet has headers: Timestamp, Client, Category, Question, Score)
    const rows = data.answers.map(ans => [
      new Date(),
      data.clientName,
      ans.category,
      ans.question,
      ans.score
    ]);

    if (rows.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, rows[0].length).setValues(rows);
    }

    return ContentService.createTextOutput(JSON.stringify({ result: "saved" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ result: "error", error: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function callGemini(stats, client) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  
  // Refined prompt for 4-7 bullets and specific insight
  const prompt = `
    You are a senior strategic partner at Lynnerup & Ansell. 
    Review the following aggregate scores (scale 1-5) for our client "${client}".
    
    Data: ${JSON.stringify(stats)}
    
    Task: Provide a high-level executive summary of the organization's maturity.
    
    Format Guidelines:
    1. Provide exactly 5-7 bullet points.
    2. Focus specifically on the "Maturity of Performance Dialogues" and "Strategic Alignment".
    3. Be direct, professional, and insightful. Do not use fluff.
    4. Highlight the most critical gap and the strongest asset.
    5. Output raw text (no markdown symbols like ##).
  `;

  const payload = {
    contents: [{ parts: [{ text: prompt }] }]
  };

  const options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const json = JSON.parse(response.getContentText());
    return json.candidates[0].content.parts[0].text;
  } catch (e) {
    return "Unable to generate analysis at this time. Please rely on the data visualization.";
  }
}
